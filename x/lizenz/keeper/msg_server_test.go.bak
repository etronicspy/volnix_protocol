package keeper

import (
	"testing"
	"time"

	"github.com/stretchr/testify/require"
	"github.com/stretchr/testify/suite"

	storetypes "cosmossdk.io/store/types"
	"github.com/cosmos/cosmos-sdk/codec"
	cdctypes "github.com/cosmos/cosmos-sdk/codec/types"
	"github.com/cosmos/cosmos-sdk/std"
	"github.com/cosmos/cosmos-sdk/testutil"
	sdk "github.com/cosmos/cosmos-sdk/types"
	paramskeeper "github.com/cosmos/cosmos-sdk/x/params/keeper"
	paramtypes "github.com/cosmos/cosmos-sdk/x/params/types"

	lizenzv1 "github.com/volnix-protocol/volnix-protocol/proto/gen/go/volnix/lizenz/v1"
	"github.com/volnix-protocol/volnix-protocol/x/lizenz/types"
)

type MsgServerTestSuite struct {
	suite.Suite

	cdc        codec.Codec
	ctx        sdk.Context
	keeper     *Keeper
	msgServer  lizenzv1.MsgServer
	storeKey   storetypes.StoreKey
	paramStore paramtypes.Subspace
}

func (suite *MsgServerTestSuite) SetupTest() {
	// Create codec
	interfaceRegistry := cdctypes.NewInterfaceRegistry()
	std.RegisterInterfaces(interfaceRegistry)
	suite.cdc = codec.NewProtoCodec(interfaceRegistry)

	// Create store keys
	suite.storeKey = storetypes.NewKVStoreKey("test_lizenz")
	tKey := storetypes.NewTransientStoreKey("test_transient_store")

	// Create test context
	suite.ctx = testutil.DefaultContext(suite.storeKey, tKey)

	// Create params keeper and subspace
	paramsKeeper := paramskeeper.NewKeeper(suite.cdc, codec.NewLegacyAmino(), suite.storeKey, tKey)
	suite.paramStore = paramsKeeper.Subspace(types.ModuleName)
	suite.paramStore.WithKeyTable(types.ParamKeyTable())

	// Create keeper and msg server
	suite.keeper = NewKeeper(suite.cdc, suite.storeKey, suite.paramStore)
	suite.msgServer = NewMsgServerImpl(suite.keeper)

	// Set default params
	suite.keeper.SetParams(suite.ctx, types.DefaultParams())
}

func (suite *MsgServerTestSuite) TestCreateLizenz() {
	// Test valid lizenz creation
	msg := &lizenzv1.MsgCreateLizenz{
		Creator:      "cosmos1test",
		Amount:       "1000000",
		IdentityHash: "hash123",
	}

	resp, err := suite.msgServer.CreateLizenz(suite.ctx, msg)
	require.NoError(suite.T(), err)
	require.NotNil(suite.T(), resp)

	// Verify lizenz was created
	lizenz, err := suite.keeper.GetLizenz(suite.ctx, "cosmos1test")
	require.NoError(suite.T(), err)
	require.Equal(suite.T(), "cosmos1test", lizenz.Owner)
	require.Equal(suite.T(), "1000000", lizenz.Amount)

	// Test duplicate lizenz creation (should fail)
	_, err = suite.msgServer.CreateLizenz(suite.ctx, msg)
	require.Error(suite.T(), err)
	require.Equal(suite.T(), types.ErrLizenzAlreadyExists, err)

	// Test invalid amount
	invalidMsg := &lizenzv1.MsgCreateLizenz{
		Creator:      "cosmos2test",
		Amount:       "",
		IdentityHash: "hash456",
	}

	_, err = suite.msgServer.CreateLizenz(suite.ctx, invalidMsg)
	require.Error(suite.T(), err)
}

func (suite *MsgServerTestSuite) TestActivateLizenz() {
	// First create a lizenz
	createMsg := &lizenzv1.MsgCreateLizenz{
		Creator:      "cosmos1test",
		Amount:       "1000000",
		IdentityHash: "hash123",
	}

	_, err := suite.msgServer.CreateLizenz(suite.ctx, createMsg)
	require.NoError(suite.T(), err)

	// Test valid activation
	msg := &lizenzv1.MsgActivateLizenz{
		Creator:      "cosmos1test",
		IdentityHash: "hash123",
	}

	resp, err := suite.msgServer.ActivateLizenz(suite.ctx, msg)
	require.NoError(suite.T(), err)
	require.NotNil(suite.T(), resp)

	// Verify lizenz is activated
	lizenz, err := suite.keeper.GetLizenz(suite.ctx, "cosmos1test")
	require.NoError(suite.T(), err)
	require.Equal(suite.T(), lizenzv1.LizenzStatus_LIZENZ_STATUS_ACTIVE, lizenz.Status)

	// Test activating non-existent lizenz
	nonExistentMsg := &lizenzv1.MsgActivateLizenz{
		Creator:      "cosmos2test",
		IdentityHash: "hash456",
	}

	_, err = suite.msgServer.ActivateLizenz(suite.ctx, nonExistentMsg)
	require.Error(suite.T(), err)
	require.Equal(suite.T(), types.ErrLizenzNotFound, err)
}

func (suite *MsgServerTestSuite) TestDeactivateLizenz() {
	// First create and activate a lizenz
	createMsg := &lizenzv1.MsgCreateLizenz{
		Creator:      "cosmos1test",
		Amount:       "1000000",
		IdentityHash: "hash123",
	}

	_, err := suite.msgServer.CreateLizenz(suite.ctx, createMsg)
	require.NoError(suite.T(), err)

	activateMsg := &lizenzv1.MsgActivateLizenz{
		Creator:      "cosmos1test",
		IdentityHash: "hash123",
	}

	_, err = suite.msgServer.ActivateLizenz(suite.ctx, activateMsg)
	require.NoError(suite.T(), err)

	// Test valid deactivation
	msg := &lizenzv1.MsgDeactivateLizenz{
		Creator:      "cosmos1test",
		IdentityHash: "hash123",
	}

	resp, err := suite.msgServer.DeactivateLizenz(suite.ctx, msg)
	require.NoError(suite.T(), err)
	require.NotNil(suite.T(), resp)

	// Verify lizenz is deactivated
	lizenz, err := suite.keeper.GetLizenz(suite.ctx, "cosmos1test")
	require.NoError(suite.T(), err)
	require.Equal(suite.T(), lizenzv1.LizenzStatus_LIZENZ_STATUS_INACTIVE, lizenz.Status)

	// Test deactivating non-existent lizenz
	nonExistentMsg := &lizenzv1.MsgDeactivateLizenz{
		Creator:      "cosmos2test",
		IdentityHash: "hash456",
	}

	_, err = suite.msgServer.DeactivateLizenz(suite.ctx, nonExistentMsg)
	require.Error(suite.T(), err)
	require.Equal(suite.T(), types.ErrLizenzNotFound, err)
}

func (suite *MsgServerTestSuite) TestTransferLizenz() {
	// First create a lizenz
	createMsg := &lizenzv1.MsgCreateLizenz{
		Creator:      "cosmos1test",
		Amount:       "1000000",
		IdentityHash: "hash123",
	}

	_, err := suite.msgServer.CreateLizenz(suite.ctx, createMsg)
	require.NoError(suite.T(), err)

	// Test valid transfer
	msg := &lizenzv1.MsgTransferLizenz{
		Creator:      "cosmos1test",
		ToAddress:    "cosmos2test",
		IdentityHash: "hash123",
	}

	resp, err := suite.msgServer.TransferLizenz(suite.ctx, msg)
	require.NoError(suite.T(), err)
	require.NotNil(suite.T(), resp)

	// Verify lizenz is transferred
	lizenz, err := suite.keeper.GetLizenz(suite.ctx, "cosmos2test")
	require.NoError(suite.T(), err)
	require.Equal(suite.T(), "cosmos2test", lizenz.Owner)

	// Verify old owner no longer has lizenz
	_, err = suite.keeper.GetLizenz(suite.ctx, "cosmos1test")
	require.Error(suite.T(), err)
	require.Equal(suite.T(), types.ErrLizenzNotFound, err)

	// Test transferring non-existent lizenz
	nonExistentMsg := &lizenzv1.MsgTransferLizenz{
		Creator:      "cosmos3test",
		ToAddress:    "cosmos4test",
		IdentityHash: "hash456",
	}

	_, err = suite.msgServer.TransferLizenz(suite.ctx, nonExistentMsg)
	require.Error(suite.T(), err)
	require.Equal(suite.T(), types.ErrLizenzNotFound, err)
}

func (suite *MsgServerTestSuite) TestUpdateMOA() {
	// First create and activate a lizenz
	createMsg := &lizenzv1.MsgCreateLizenz{
		Creator:      "cosmos1test",
		Amount:       "1000000",
		IdentityHash: "hash123",
	}

	_, err := suite.msgServer.CreateLizenz(suite.ctx, createMsg)
	require.NoError(suite.T(), err)

	activateMsg := &lizenzv1.MsgActivateLizenz{
		Creator:      "cosmos1test",
		IdentityHash: "hash123",
	}

	_, err = suite.msgServer.ActivateLizenz(suite.ctx, activateMsg)
	require.NoError(suite.T(), err)

	// Test updating MOA
	msg := &lizenzv1.MsgUpdateMOA{
		Creator:      "cosmos1test",
		NewAmount:    "2000000",
		IdentityHash: "hash123",
	}

	resp, err := suite.msgServer.UpdateMOA(suite.ctx, msg)
	require.NoError(suite.T(), err)
	require.NotNil(suite.T(), resp)

	// Verify MOA was updated
	lizenz, err := suite.keeper.GetLizenz(suite.ctx, "cosmos1test")
	require.NoError(suite.T(), err)
	require.Equal(suite.T(), "2000000", lizenz.Amount)

	// Test updating MOA for non-existent lizenz
	nonExistentMsg := &lizenzv1.MsgUpdateMOA{
		Creator:      "cosmos2test",
		NewAmount:    "1000000",
		IdentityHash: "hash456",
	}

	_, err = suite.msgServer.UpdateMOA(suite.ctx, nonExistentMsg)
	require.Error(suite.T(), err)
	require.Equal(suite.T(), types.ErrLizenzNotFound, err)
}

func TestMsgServerTestSuite(t *testing.T) {
	suite.Run(t, new(MsgServerTestSuite))
}

