# Тесты для Волникс Протокол

## Обзор

Этот проект содержит комплексные тесты для всех модулей Волникс Протокол, включая unit тесты, integration тесты, тесты безопасности и бенчмарки.

## Структура тестов

```
tests/
├── integration_test.go    # Integration тесты для экономических сценариев
├── security_test.go       # Тесты безопасности для ZKP и аукционов
├── benchmark_test.go      # Бенчмарки для критических операций
└── end_to_end_test.go     # End-to-end тесты полных сценариев

x/
├── ident/keeper/
│   ├── keeper_test.go     # Unit тесты для keeper
│   ├── msg_server_test.go # Тесты для msg server
│   └── query_server_test.go # Тесты для query server
├── lizenz/keeper/
│   ├── keeper_test.go     # Unit тесты для keeper
│   └── msg_server_test.go # Тесты для msg server
├── anteil/keeper/
│   ├── keeper_test.go     # Unit тесты для keeper
│   └── msg_server_test.go # Тесты для msg server
└── consensus/keeper/
    ├── keeper_test.go     # Unit тесты для keeper
    └── msg_server_test.go # Тесты для msg server
```

## Типы тестов

### 1. Unit тесты
- **Keeper тесты**: Тестируют основную логику каждого модуля
- **MsgServer тесты**: Тестируют обработку сообщений
- **QueryServer тесты**: Тестируют запросы к модулям

### 2. Integration тесты
- **Полный экономический цикл**: От создания аккаунтов до торговли ANT
- **Миграция ролей**: Тестирование "цифрового наследства"
- **Нарушения MOA**: Проверка системы наказаний
- **Халвинг**: Тестирование экономических механизмов

### 3. Тесты безопасности
- **ZKP верификация**: Проверка криптографических операций
- **Безопасность аукционов**: Защита от манипуляций
- **Безопасность ордеров**: Валидация торговых операций
- **Защита от атак Сивиллы**: Предотвращение множественных аккаунтов

### 4. Бенчмарки
- **Создание аккаунтов**: Производительность верификации
- **Создание ордеров**: Скорость торговых операций
- **Выполнение сделок**: Производительность matching engine
- **Аукционы**: Скорость создания и урегулирования

## Запуск тестов

### Использование Makefile
```bash
# Запуск всех тестов
make -f Makefile.test test-all

# Запуск только unit тестов
make -f Makefile.test test-unit

# Запуск integration тестов
make -f Makefile.test test-integration

# Запуск тестов безопасности
make -f Makefile.test test-security

# Запуск бенчмарков
make -f Makefile.test test-benchmark

# Запуск с покрытием кода
make -f Makefile.test test-coverage

# Запуск с детекцией гонок
make -f Makefile.test test-race
```

### Прямой запуск через go test
```bash
# Все тесты
go test -v ./...

# Конкретный модуль
go test -v ./x/ident/keeper/...

# Конкретный тест
go test -v ./tests/... -run TestIntegrationTestSuite

# Бенчмарки
go test -v ./tests/... -bench=.

# С покрытием
go test -v -coverprofile=coverage.out ./...
go tool cover -html=coverage.out -o coverage.html
```

## Тестовые сценарии

### 1. Полный экономический цикл
1. **Верификация идентичности**: Создание граждан и валидаторов
2. **Создание LZN**: Лицензии для валидаторов
3. **Активация LZN**: Активация лицензий
4. **Создание ANT позиций**: Права на производительность
5. **Торговля**: Создание и выполнение ордеров
6. **Аукционы**: Создание и урегулирование аукционов
7. **Консенсус**: Обновление состояния консенсуса

### 2. Миграция ролей
1. **Создание исходного аккаунта**: Гражданин с ANT позицией
2. **Создание ордеров**: Торговые ордера
3. **Инициация миграции**: Установка миграции роли
4. **Выполнение миграции**: Перенос всех активов
5. **Верификация**: Проверка успешной миграции

### 3. Нарушения MOA
1. **Создание валидатора**: Аккаунт с LZN
2. **Активация LZN**: Активация лицензии
3. **Симуляция нарушения**: Установка старого времени активности
4. **Проверка MOA**: Запуск BeginBlocker
5. **Наказание**: Деактивация LZN и удаление из валидаторов

## Метрики производительности

### Ожидаемые показатели
- **Создание аккаунта**: < 1ms
- **Создание ордера**: < 1ms
- **Выполнение сделки**: < 5ms
- **Создание аукциона**: < 1ms
- **Урегулирование аукциона**: < 10ms
- **Запрос всех ордеров**: < 100ms (для 1000 ордеров)

### Ограничения памяти
- **10000 аккаунтов**: < 50MB
- **10000 ордеров**: < 100MB
- **1000 аукционов**: < 20MB

## Требования к тестам

### Обязательные проверки
1. **Валидация входных данных**: Все функции должны проверять входные параметры
2. **Обработка ошибок**: Корректная обработка всех возможных ошибок
3. **Состояние системы**: Проверка корректности изменений состояния
4. **Безопасность**: Защита от всех известных атак
5. **Производительность**: Соответствие требованиям по скорости

### Покрытие кода
- **Минимальное покрытие**: 80%
- **Критические функции**: 100%
- **Бизнес-логика**: 95%
- **Обработка ошибок**: 90%

## Отладка тестов

### Полезные флаги
```bash
# Подробный вывод
go test -v

# Запуск конкретного теста
go test -run TestSpecificTest

# Параллельное выполнение
go test -parallel 4

# Таймаут
go test -timeout 30s

# Пропуск кэширования
go test -count=1
```

### Логирование
```bash
# Включение логов
go test -v -args -log-level=debug

# Сохранение логов в файл
go test -v 2>&1 | tee test.log
```

## Непрерывная интеграция

### GitHub Actions
```yaml
name: Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-go@v2
        with:
          go-version: 1.21
      - run: make -f Makefile.test test-all
      - run: make -f Makefile.test test-coverage
```

## Устранение неполадок

### Частые проблемы
1. **Импорты**: Убедитесь, что все импорты корректны
2. **Зависимости**: Проверьте go.mod и go.sum
3. **Порядок тестов**: Некоторые тесты могут зависеть от порядка выполнения
4. **Состояние**: Очищайте состояние между тестами

### Решения
```bash
# Очистка кэша
go clean -testcache

# Обновление зависимостей
go mod tidy

# Проверка импортов
go mod verify
```

## Вклад в тесты

### Добавление новых тестов
1. Создайте тест в соответствующем файле
2. Следуйте существующим паттернам
3. Добавьте документацию
4. Обновите Makefile при необходимости

### Стандарты
- Используйте `testify/require` для проверок
- Группируйте связанные тесты в suite
- Добавляйте комментарии для сложной логики
- Тестируйте как успешные, так и неуспешные сценарии

## Заключение

Этот набор тестов обеспечивает полное покрытие функциональности Волникс Протокол и гарантирует безопасность и производительность системы. Регулярное выполнение тестов помогает поддерживать качество кода и предотвращать регрессии.

