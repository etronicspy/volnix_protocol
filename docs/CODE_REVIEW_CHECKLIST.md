# Чеклист для проверки кода на чистоту и отсутствие "магического кода"

## Разделение проекта на части для проверки

Проект разделен на следующие логические части для последовательной проверки:

### 1. Блокчейн Core (app/, cmd/)
**Приоритет:** Критический  
**Сложность:** Высокая  
**Файлы:**
- `app/app.go` - основное приложение
- `app/abci_wrapper.go` - ABCI интерфейс
- `app/ante.go` - ante handlers
- `app/server.go` - сервер
- `cmd/volnixd/main.go` - CLI команды
- `cmd/volnixd-standalone/main.go` - standalone сервер

**Время проверки:** 2-3 часа

### 2. Модуль Identity (x/ident/)
**Приоритет:** Высокий  
**Сложность:** Средняя  
**Файлы:**
- `x/ident/keeper/keeper.go` - основная логика
- `x/ident/keeper/msg_server.go` - обработка сообщений
- `x/ident/keeper/query_server.go` - запросы
- `x/ident/keeper/zkp_verifier.go` - ZKP верификация
- `x/ident/types/` - типы данных
- `x/ident/genesis.go` - genesis инициализация

**Время проверки:** 1-2 часа

### 3. Модуль Lizenz (x/lizenz/)
**Приоритет:** Высокий  
**Сложность:** Средняя  
**Файлы:**
- `x/lizenz/keeper/keeper.go` - основная логика
- `x/lizenz/keeper/msg_server.go` - обработка сообщений
- `x/lizenz/keeper/query_server.go` - запросы
- `x/lizenz/keeper/reward_tracker.go` - отслеживание наград
- `x/lizenz/types/` - типы данных
- `x/lizenz/genesis.go` - genesis инициализация

**Время проверки:** 1-2 часа

### 4. Модуль Anteil (x/anteil/)
**Приоритет:** Высокий  
**Сложность:** Высокая  
**Файлы:**
- `x/anteil/keeper/keeper.go` - основная логика
- `x/anteil/keeper/msg_server.go` - обработка сообщений
- `x/anteil/keeper/query_server.go` - запросы
- `x/anteil/keeper/economic_engine.go` - экономический движок
- `x/anteil/types/` - типы данных
- `x/anteil/genesis.go` - genesis инициализация

**Время проверки:** 2-3 часа

### 5. Модуль Consensus (x/consensus/)
**Приоритет:** Критический  
**Сложность:** Очень высокая  
**Файлы:**
- `x/consensus/keeper/keeper.go` - основная логика PoVB
- `x/consensus/keeper/msg_server.go` - обработка сообщений
- `x/consensus/keeper/query_server.go` - запросы
- `x/consensus/types/` - типы данных
- `x/consensus/genesis.go` - genesis инициализация

**Время проверки:** 3-4 часа

### 6. Модуль Governance (x/governance/)
**Приоритет:** Средний  
**Сложность:** Средняя  
**Файлы:**
- `x/governance/keeper/keeper.go` - основная логика
- `x/governance/keeper/msg_server.go` - обработка сообщений
- `x/governance/keeper/query_server.go` - запросы
- `x/governance/keeper/parameter_applier.go` - применение параметров
- `x/governance/types/` - типы данных
- `x/governance/genesis.go` - genesis инициализация

**Время проверки:** 1-2 часа

### 7. Protobuf определения (proto/volnix/)
**Приоритет:** Высокий  
**Сложность:** Низкая  
**Файлы:**
- `proto/volnix/ident/` - определения для ident
- `proto/volnix/lizenz/` - определения для lizenz
- `proto/volnix/anteil/` - определения для anteil
- `proto/volnix/consensus/` - определения для consensus
- `proto/volnix/governance/` - определения для governance

**Время проверки:** 30 минут - 1 час

### 8. Backend API (backend/api/)
**Приоритет:** Средний  
**Сложность:** Средняя  
**Файлы:**
- `backend/api/server.go` - REST API сервер
- `backend/api/main.go` - точка входа

**Время проверки:** 1 час

### 9. Frontend (frontend/)
**Приоритет:** Низкий  
**Сложность:** Средняя  
**Файлы:**
- `frontend/wallet-ui/src/` - React компоненты
- `frontend/blockchain-explorer/src/` - Explorer компоненты

**Время проверки:** 2-3 часа

### 10. Тесты (tests/, x/*/keeper/*_test.go)
**Приоритет:** Высокий  
**Сложность:** Средняя  
**Файлы:**
- `tests/` - интеграционные тесты
- `x/*/keeper/*_test.go` - unit тесты модулей

**Время проверки:** 2-3 часа

### 11. Инфраструктура (infrastructure/, scripts/)
**Приоритет:** Низкий  
**Сложность:** Низкая  
**Файлы:**
- `infrastructure/docker/` - Docker скрипты
- `infrastructure/monitoring/` - конфигурация мониторинга
- `scripts/` - скрипты запуска

**Время проверки:** 1 час

---

## Чеклист проверки кода

### Общие принципы

#### ✅ 1. Отсутствие "магических чисел" (Magic Numbers)
- [ ] Все числовые константы вынесены в константы или параметры
- [ ] Нет хардкода значений типа `100`, `1000`, `1000000`, `24`, `60`, `3600`, `86400`
- [ ] Временные интервалы определены как константы с понятными именами
- [ ] Проценты и коэффициенты вынесены в параметры модуля
- [ ] Размеры буферов и лимиты определены как константы

**Примеры плохого кода:**
```go
// ❌ Плохо
if balance > 1000000 {
    return errors.New("insufficient funds")
}

// ✅ Хорошо
const MinBalance = 1000000
if balance > MinBalance {
    return errors.New("insufficient funds")
}
```

#### ✅ 2. Отсутствие хардкода строк (Hardcoded Strings)
- [ ] Все строковые константы вынесены в константы
- [ ] Сообщения об ошибках определены в `types/errors.go`
- [ ] Имена модулей и префиксы определены как константы
- [ ] URL и адреса вынесены в конфигурацию

**Примеры плохого кода:**
```go
// ❌ Плохо
if moduleName == "ident" {
    // ...
}

// ✅ Хорошо
const IdentModuleName = "ident"
if moduleName == IdentModuleName {
    // ...
}
```

#### ✅ 3. Правильная обработка ошибок
- [ ] Все ошибки обернуты с контекстом (`fmt.Errorf` с `%w`)
- [ ] Используются кастомные типы ошибок для доменных ошибок
- [ ] Ошибки регистрируются в `types/errors.go`
- [ ] Нет игнорирования ошибок (`_ = func()`)
- [ ] Паники используются только для критических ошибок

**Примеры плохого кода:**
```go
// ❌ Плохо
result, _ := someFunction()

// ✅ Хорошо
result, err := someFunction()
if err != nil {
    return fmt.Errorf("failed to execute function: %w", err)
}
```

#### ✅ 4. Структурированное логирование
- [ ] Используется структурированное логирование с контекстом
- [ ] Логи содержат: module name, operation, account address, tx hash, block height
- [ ] Уровни логирования используются правильно (DEBUG, INFO, WARN, ERROR, FATAL)
- [ ] Нет логирования чувствительных данных (private keys, passwords)
- [ ] Логирование происходит в критических точках

**Примеры плохого кода:**
```go
// ❌ Плохо
fmt.Println("Processing transaction")

// ✅ Хорошо
ctx.Logger().Info("processing transaction",
    "module", "ident",
    "tx_hash", txHash,
    "account", accountAddr,
)
```

#### ✅ 5. Валидация входных данных
- [ ] Все входные параметры валидируются
- [ ] Используются Cosmos SDK валидаторы (`sdk.ValidateAddress`, `sdk.ValidateDenom`)
- [ ] Проверяются границы значений (min/max)
- [ ] Валидация происходит в message handlers
- [ ] Возвращаются понятные сообщения об ошибках

**Примеры плохого кода:**
```go
// ❌ Плохо
func (k Keeper) ProcessAmount(amount string) {
    // нет валидации
}

// ✅ Хорошо
func (k Keeper) ProcessAmount(amount string) error {
    amt, err := sdk.ParseCoin(amount)
    if err != nil {
        return fmt.Errorf("invalid amount: %w", err)
    }
    if amt.IsZero() {
        return types.ErrInvalidAmount
    }
    // ...
}
```

#### ✅ 6. Использование параметров модуля
- [ ] Все конфигурируемые значения хранятся в параметрах модуля
- [ ] Параметры определены в `types/params.go`
- [ ] Параметры валидируются в `Validate()` методе
- [ ] Изменение параметров происходит через governance
- [ ] Параметры имеют значения по умолчанию

**Примеры плохого кода:**
```go
// ❌ Плохо
const MaxOrders = 100 // хардкод в коде

// ✅ Хорошо
// В types/params.go
type Params struct {
    MaxOrdersPerUser uint64 `protobuf:"varint,1,opt,name=max_orders_per_user,json=maxOrdersPerUser,proto3" json:"max_orders_per_user"`
}
```

#### ✅ 7. Правильная работа с типами
- [ ] Используются правильные типы Cosmos SDK (`sdk.Coin`, `sdk.AccAddress`)
- [ ] Нет смешивания `string` и `sdk.AccAddress`
- [ ] Используются `math.Int` и `math.LegacyDec` для больших чисел
- [ ] Нет прямых преобразований без проверок

**Примеры плохого кода:**
```go
// ❌ Плохо
address := string(addr) // потеря типа

// ✅ Хорошо
address := addr.String() // явное преобразование
```

#### ✅ 8. Безопасность
- [ ] Нет хардкода приватных ключей или seed фраз
- [ ] Нет логирования чувствительных данных
- [ ] Проверяются права доступа перед операциями
- [ ] Используются безопасные криптографические функции
- [ ] Нет SQL injection или других уязвимостей

#### ✅ 9. Производительность
- [ ] Нет неэффективных циклов (O(n²))
- [ ] Используется кэширование где необходимо
- [ ] Нет лишних запросов к state store
- [ ] Используются batch операции где возможно
- [ ] Нет утечек памяти (goroutines, channels)

#### ✅ 10. Тестируемость
- [ ] Код разделен на небольшие функции
- [ ] Функции имеют одну ответственность
- [ ] Зависимости инжектируются через интерфейсы
- [ ] Нет глобальных переменных
- [ ] Код покрыт тестами (>80% для keeper'ов)

---

### Специфичные проверки для модулей

#### Модуль Identity (x/ident/)

- [ ] Роли определены как константы (Guest, Citizen, Validator)
- [ ] ZKP верификация использует правильные алгоритмы
- [ ] Миграция идентичности проверяет все условия
- [ ] Activity tracking обновляется корректно
- [ ] Нет хардкода адресов или ролей

**Проверка магических чисел:**
```bash
grep -r "\b[0-9]\{3,\}\b" x/ident/keeper/ | grep -v "_test.go"
```

#### Модуль Lizenz (x/lizenz/)

- [ ] MOA параметры хранятся в параметрах модуля
- [ ] Penalty коэффициенты конфигурируемые
- [ ] Reward calculation использует параметры
- [ ] Activation/deactivation проверяет все условия
- [ ] Нет хардкода временных интервалов

**Проверка магических чисел:**
```bash
grep -r "\b[0-9]\{3,\}\b" x/lizenz/keeper/ | grep -v "_test.go"
```

#### Модуль Anteil (x/anteil/)

- [ ] Order matching алгоритм оптимизирован
- [ ] Auction параметры в параметрах модуля
- [ ] Fee проценты конфигурируемые
- [ ] Price calculation использует правильные формулы
- [ ] Нет хардкода лимитов ордеров

**Проверка магических чисел:**
```bash
grep -r "\b[0-9]\{3,\}\b" x/anteil/keeper/ | grep -v "_test.go"
```

#### Модуль Consensus (x/consensus/)

- [ ] PoVB алгоритм использует параметры
- [ ] Halving параметры конфигурируемые
- [ ] Block creator selection справедливый
- [ ] Reward distribution использует параметры
- [ ] Нет хардкода весов или коэффициентов

**Проверка магических чисел:**
```bash
grep -r "\b[0-9]\{3,\}\b" x/consensus/keeper/ | grep -v "_test.go"
```

#### Модуль Governance (x/governance/)

- [ ] Proposal параметры в параметрах модуля
- [ ] Voting thresholds конфигурируемые
- [ ] Parameter changes валидируются
- [ ] Нет хардкода кворумов или порогов

**Проверка магических чисел:**
```bash
grep -r "\b[0-9]\{3,\}\b" x/governance/keeper/ | grep -v "_test.go"
```

---

### Проверка app/ и cmd/

- [ ] Genesis параметры валидируются
- [ ] Module manager правильно настроен
- [ ] ABCI handlers обрабатывают ошибки
- [ ] Нет хардкода chain ID или bech32 префиксов
- [ ] Конфигурация загружается из файлов

**Проверка магических чисел:**
```bash
grep -r "\b[0-9]\{3,\}\b" app/ cmd/ | grep -v "_test.go"
```

---

### Инструменты для автоматической проверки

#### 1. Поиск магических чисел
```bash
# Найти все числа >= 100 в коде (исключая тесты)
grep -rn "\b[0-9]\{3,\}\b" x/ app/ cmd/ --include="*.go" | grep -v "_test.go" | grep -v "// " | grep -v "const " | grep -v "var "
```

#### 2. Поиск хардкода строк
```bash
# Найти строковые литералы в коде
grep -rn '"[a-z_]\{3,\}"' x/ app/ cmd/ --include="*.go" | grep -v "_test.go" | grep -v "const " | grep -v "error("
```

#### 3. Проверка игнорирования ошибок
```bash
# Найти игнорирование ошибок
grep -rn "_, err :=" x/ app/ cmd/ --include="*.go"
grep -rn "err = " x/ app/ cmd/ --include="*.go" | grep -v "if err"
```

#### 4. Проверка использования fmt.Println
```bash
# Найти использование fmt.Println вместо структурированного логирования
grep -rn "fmt\.Print" x/ app/ cmd/ --include="*.go" | grep -v "_test.go"
```

#### 5. Проверка паник
```bash
# Найти использование panic (кроме тестов)
grep -rn "panic(" x/ app/ cmd/ --include="*.go" | grep -v "_test.go"
```

---

### Приоритеты исправления

1. **Критический** - магические числа в экономической логике (consensus, anteil)
2. **Высокий** - хардкод параметров, которые должны быть конфигурируемыми
3. **Средний** - отсутствие валидации входных данных
4. **Низкий** - улучшение логирования и обработки ошибок

---

### Шаблон отчета о проверке

```markdown
## Проверка модуля: [Название]

**Дата:** [Дата]
**Проверяющий:** [Имя]
**Время проверки:** [Время]

### Найденные проблемы

#### Критические
- [ ] [Описание проблемы] - [Файл:Строка]

#### Высокий приоритет
- [ ] [Описание проблемы] - [Файл:Строка]

#### Средний приоритет
- [ ] [Описание проблемы] - [Файл:Строка]

### Статистика
- Магических чисел найдено: [N]
- Хардкода строк найдено: [N]
- Игнорируемых ошибок: [N]
- Покрытие тестами: [N]%

### Рекомендации
- [Рекомендация 1]
- [Рекомендация 2]
```

---

## Быстрый старт проверки

1. Выберите модуль из списка выше
2. Запустите инструменты автоматической проверки
3. Просмотрите код модуля согласно чеклисту
4. Заполните отчет о проверке
5. Создайте issues для найденных проблем
6. Исправьте проблемы согласно приоритетам

---

**Последнее обновление:** 2025-01-30  
**Версия чеклиста:** 1.0

